package com.tmobile.cso.pacman.aqua.jobs;


import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.gson.Gson;
import com.tmobile.cso.pacman.aqua.Constants;
import com.tmobile.cso.pacman.aqua.dto.ImageVulnerabilityResponse;
import com.tmobile.cso.pacman.aqua.dto.Result;
import com.tmobile.cso.pacman.aqua.util.ElasticSearchManager;
import com.tmobile.cso.pacman.aqua.util.HttpUtil;
import com.tmobile.cso.pacman.aqua.util.Util;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class AquaFunctionVulnerabilityDataImporter extends AquaDataImporter implements Constants {


  protected static final String AQUA_CLIENT_DOMAIN_URL = System.getProperty("aqua_client_domain_url");
  protected static final int DEFAULT_PAGE_SIZE = Integer.parseInt(System.getProperty("default_page_size"));
  protected static final String AQUA_VM_VULNERABILITY_API_QUERY_PARAMS = System.getProperty("aqua_vm_vul_query_params");

  private static Logger log = LoggerFactory.getLogger(AquaFunctionVulnerabilityDataImporter.class);

  /** The Constant index. */
  private final static String index = "aqua-vm-vulnerability";

  /** The Constant type. */
  private final static String type = "vulnerability";

  /** The Constant docid. */
  private final static String docid = "name";


  public Map<String, Object> execute() {
    String token = getBearerToken();
    getAndUploadVulnerabilityData(token);
    System.out.println(token);
    return null;
  }

  private void getAndUploadVulnerabilityData(String token) {
    try {
      int currentPage = 1;
      boolean isLastPage = false;
      Gson gson = Util.getJsonBuilder();
      do {
        String pagination = "&page=" + currentPage + "&pagesize=" + DEFAULT_PAGE_SIZE;
        String vulnerabilityURI = AQUA_CLIENT_DOMAIN_URL +
            apiMap.get("vm_vulnerabilities") +
            URL_SEPARATOR +
            AQUA_VM_VULNERABILITY_API_QUERY_PARAMS +
            pagination;
        ImageVulnerabilityResponse response = gson.fromJson(HttpUtil.get(vulnerabilityURI, token), ImageVulnerabilityResponse.class);
        int currentCount = response.getPage() * response.getPagesize();
        if (currentCount >= response.getCount()) {
          isLastPage = true;
        }
        //System.out.println(response.getResult());
        for(Result res : response.getResult()){
          System.out.println(res);
        }
        uploadToES(response);
        System.out.println(response.getPage());
        System.out.println(response.getResult().get(0).getPublish_date());
        currentPage++;
      }
      while (!isLastPage);
    } catch (Exception e) {
      e.printStackTrace();
    }
  }

  private String uploadToES(ImageVulnerabilityResponse response) {
    ObjectMapper objectMapper = new ObjectMapper();
    objectMapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd"));
    List<Map<String, Object>> vulnDetails = new ArrayList<>();
    synchronized (vulnDetails) {
      response.getResult().stream().forEach(vuln ->
      vulnDetails.add(objectMapper.convertValue(vuln, Map.class)));
    }
    ElasticSearchManager.createIndex(index);
    ElasticSearchManager.createType(index, type);
    ElasticSearchManager.uploadData(index, type, vulnDetails, docid);
    return null;
  }
}
